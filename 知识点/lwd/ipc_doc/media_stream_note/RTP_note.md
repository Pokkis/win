

### 1、RTP 概述：

实时传送协议（Real-time Transport Protocol 或简写 RTP，也可以写成 RTTP）是一个网络传输协议，它是由 [IETF](http://baike.baidu.com/view/155093.htm) 的多媒体传输工作小组1996年在 RFC 1889中公布的。

RTP 协议详细说明了在互联网上传递音频和视频的标准数据包格式。它一开始被设计为一个多播协议，但后来被用在很多单播应用中。RTP协议常用于流媒体系统（配合 RTCP 协议或者 RTSP 协议）。因为 RTP 自身具有 Time stamp 所以在 ffmpeg 中被用做一种 formate.

#### 1.1、RTP协议格式：

```
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |V=2|P|X|  CC   |M|     PT      |       sequence number         |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                           timestamp                           |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |           synchronization source (SSRC) identifier            |
   +=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+
   |            contributing source (CSRC) identifiers             |
   |                             ....                              |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
上图引自rfc3550，由上图中可知道RTP报文由两个部分构成--RTP报头和RTP的负载：
```

RTP 报文由两部分组成：报头和有效载荷。RTP 报头格式如上图所示，其中：

1、V: RTP 协议的版本号，占2位，当前协议版本号为2。

2、P: 填充标志，占1位，如果P=1，则在该报文的尾部填充一个或多个额外的八位组，它们不是有效载荷的一部分。

3、X: 扩展标志，占1位，如果X=1，则在 RTP 报头后跟有一个扩展报头。

4、CC: CSRC 计数器，占4位，指示 CSRC 标识符的个数。

5、M: 标记，占1位，不同的有效载荷有不同的含义，对于视频，标记一帧的结束；对于音频，标记会话的开始。

6、PT: 有效载荷类型，占7位，用于说明 RTP 报文中有效载荷的类型，如 GSM 音频、JPEM 图像等，在流媒体中大部分是用来区分音频流和视频流的，这样便于客户端进行解析。

7、序列号: 占16位，用于标识发送者所发送的 RTP 报文的序列号，每发送一个报文，序列号增1。这个字段当下层的承载协议用 UDP 的时候，网络状况不好的时候可以用来检查丢包。同时出现网络抖动的情况可以用来对数据进行重新排序，在 helix 服务器中这个字段是从0开始的，同时音频包和视频包的 sequence 是分别记数的。

8、时戳(Timestamp): 占32位，时戳反映了该RTP报文的第一个八位组的采样时刻。接收者使用时戳来计算延迟和延迟抖动，并进行同步控制。

9、同步信源(SSRC)标识符: 占32位，用于标识同步信源。该标识符是随机选择的，参加同一视频会议的两个同步信源不能有相同的 SSRC。

10、特约信源(CSRC)标识符: 每个 CSRC 标识符占32位，可以有0～15个。每个 CSRC 标识了包含在该 RTP 报文有效载荷中的所有特约信源。

如果扩展标志被置位则说明紧跟在报头后面是一个头扩展，其格式如下：

```
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |      defined by profile       |           length              |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                        header extension                       |
   |                             ....                              |
```

//TODO: header extension 



#### 1.2、RTP协议的用途：

概述中已经基本阐述了 RTP 协议的用途了，其主要用于在互联网上传递音频和视频的标准数据包。在当前三网融合中 RTP 可以用来承载 TS 流，进行电视媒体数据的传播。 RTP 可以用来传送像 TS 流这种自身已经具有 formate 的媒体流，同时也可以用来承载 AVC，AAC 等去除了 fromate 的媒体流，这时 RTP 协议可被看做为一种 formate，这种形式最早常见于 helix 流媒体服务器的 RTP 流。其控制流由 RTSP 协议来提供。

### 2、RTP荷载H264码流

```
    0 1 2 3 4 5 6 7 
   +-+-+-+-+-+-+-+-+
   |F|NRI|  Type   |
   +-+-+-+-+-+-+-+-+
```

荷载格式定义三个不同的基本荷载结构，接收者可以通过 RTP 荷载的第一个字节后5位（如上图）识别荷载结构。

1、单个 NAL 单元包：荷载中只包含一个 NAL 单元。NAL 头类型域等于原始 NAL 单元类型，即在范围1到23之间；

2、聚合包：本类型用于聚合多个 NAL 单元到单个 RTP 荷载中。本包有四种版本，单时间聚合包类型 A (STAP-A)，单时间聚合包类型 B (STAP-B)，多时间聚合包类型(MTAP)16位位移(MTAP16)，多时间聚合包类型(MTAP)24位位移(MTAP24)。赋予 STAP-A、STAP-B、MTAP16、MTAP24 的 NAL 单元类型号分别是 24、25、 26、27；

3、分片单元：用于分片单个 NAL 单元到多个 RTP 包。现存两个版本FU-A，FU-B,用 NAL 单元类型 28、29标识；

注：常用的打包时的分包规则是：如果小于 MTU 采用单个 NAL 单元包，如果大于 MTU 就采用 FUs 分片方式。因为常用的打包方式就是单个 NAL 包和 FU-A 方式，所以我们只解析这两种。

#### 2.1、单个NAL单元包

```
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |F|NRI|  Type   |                                               |
   +-+-+-+-+-+-+-+-+                                               |
   |                                                               |
   |               Bytes 2..n of a Single NAL unit                 |
   |                                                               |
   |							   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                               :...OPTIONAL RTP padding        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

 定义在此的NAL单元包必须只包含一个。这意味聚合包和分片单元不可以用在单个 NAL 单元包中。并且 RTP 序号必须符合 NAL 单元的解码顺序。NAL 单元的第一字节和 RTP 荷载头第一个字节重合。如上图。

打包H264码流时，只需在帧前面加上12字节的 RTP 头即可。

#### 2.2、分片单元（FU-A）

```
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |  FU indicator |  FU header    |                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |
   |                                                               |
   |                            FU payload                         |
   |                                                               |
   |							   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                               :...OPTIONAL RTP padding        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

分片只定义于单个 NAL 单元不用于任何聚合包。NAL 单元的一个分片由整数个连续 NAL 单元字节组成。每个NAL单元字节必须正好是该 NAL 单元一个分片的一部分。相同NAL单元的分片必须使用递增的 RTP 序号连续顺序发送(第一和最后分片之间没有其他的RTP包）。相似，NAL 单元必须按照 RTP 顺序号的顺序装配。

当一个NAL单元被分片运送在分片单元(FUs)中时，被引用为分片 NAL 单元。STAPs,MTAPs不可以被分片。 FUs不可以嵌套。 即，一个FU 不可以包含另一个FU。运送FU的RTP时戳被设置成分片NAL单元的NALU时刻。

上图表示FU-A的 RTP 荷载格式。FU-A由1字节的分片单元指示（如下图A），1字节的分片单元头（如下图B），和分片单元荷载组成。

```
    0 1 2 3 4 5 6 7 
   +-+-+-+-+-+-+-+-+
   |F|NRI|  Type   |
   +-+-+-+-+-+-+-+-+
```

图A

```
    0 1 2 3 4 5 6 7 
   +-+-+-+-+-+-+-+-+
   |S|E|R|  Type   |
   +-+-+-+-+-+-+-+-+
```

图B

S: 1 bit 当设置成1,开始位指示分片 NAL 单元的开始。当跟随的 FU 荷载不是分片 NAL 单元荷载的开始，开始位设为0。

E: 1 bit 当设置成1, 结束位指示分片 NAL 单元的结束，即, 荷载的最后字节也是分片 NAL 单元的最后一个字节。当跟随的 FU荷载不是分片 NAL 单元的最后分片,结束位设置为0。

R: 1 bit 保留位必须设置为0，接收者必须忽略该位

打包时，FUindicator的F、NRI是NAL Header中的F、NRI，Type是28；FU Header的S、E、R分别按照分片起始位置设置，Type是NAL Header中的Type。

解包时，取FU indicator的前三位和FU Header的后五位，即0110 0101（0x65）为NAL类型。

###  3、RTP 荷载 PS 流

PS 流由众多 PS 包构成，每个 PS 包的基本构成形式为：
PS Header + SYS Header + PSM Header + PES Header + PES packet * N
固定包头+系统头+映射头+PES头 + 负载

针对 H264 做如下 PS 封装：每个 IDR NALU 前一般都会包含 SPS、PPS 等 NALU，因此将 SPS、PPS、IDR 的 NALU 封装为一个PS 包，包括 PS 头，然后加上PS system header，PS system map，PES header + h264 raw data。

所以一个IDR NALU PS 包由外到内顺序是：PS header | PS system header | PS system Map | PES header | h264 raw data。

对于其它非关键帧的 PS 包，就简单多了，直接加上 PS 头和 PES 头就可以了。

顺序为：PS header | PES header | h264 raw data。

以上是对只有视频 video 的情况，如果要把音频 audio 也打包进PS 封装，也可以。当有音频数据时，将数据加上PES header 放到视频PES 后就可以了。

顺序如下：PS 包=PS头|PES(video)|PES(audio)，再用 RTP 封装发送就可以了。

    GB28181 对 RTP 传输的数据负载类型有规定（参考GB28181 附录B），负载类型中96-127
    RFC2250 建议 96 表示PS 封装，建议 97 为MPEG-4，建议 98 为H264
    即我们接收到的 RTP 包首先需要判断负载类型，若负载类型为 96，则采用 PS 解复用，将音视频分开解码。若负载类型为 98，直接按照 H264 的解码类型解码。
    注：此方法不一定准确，取决于打包格式是否标准

PS 包中的流类型（stream type）的取值如下：

```
1) MPEG-4 视频流： 0x10；
2) H.264 视频流： 0x1B；
3) SVAC 视频流： 0x80；
4) G.711 音频流： 0x90；
5) G.722.1 音频流： 0x92；
6) G.723.1 音频流： 0x93；
7) G.729 音频流： 0x99；
8) SVAC音频流： 0x9B。
```

##### 3.1、PS包头

![img](.\pic_resource\RTP_note\ps_header.png)

1)    Pack start code：包起始码字段，值为0x000001BA的位串，用来标志一个包的开始。

2)    System clock reference base，system clock reference extenstion：系统时钟参考字段。

3)    Pack stuffing length ：包填充长度字段，3 位整数，规定该字段后填充字节的个数



##### 3.2、系统标题

![](.\pic_resource\RTP_note\ps_system_header.png)

PS system header 当且仅当 pack 是第一个数据包时才存在，即 PS 包头之后就是系统标题。取值0x000001BB的位串，指出系统标题的开始，暂时不需要处理，读取header_length直接跳过即可。

##### 3.3、节目映射流

![](.\pic_resource\RTP_note\ps_program_stream_map.png)

PS system map 当且仅当 pack 是第一个数据包时才存在，即系统标题之后就是节目流映射。取值0x000001BC的位串，指出节目流映射的开始，暂时不需要处理，读取 program_stream_map_length 直接跳过即可。

##### 3.4、PES 分组头部

![](.\pic_resource\RTP_note\PES_packet_info.png)

1)    Packet start code prefix：值为0x000001的位串，它和后面的stream id 构成了标识分组开始的分组起始码，用来标志一个包的开始。

2)    Stream id：在节目流中，它规定了基本流的号码和类型。0x(C0~DF)指音频，0x(E0~EF)为视频

3)    PES packet length：16 位字段，指出了PES 分组中跟在该字段后的字节数目。值为0 表示PES 分组长度要么没有规定要么没有限制。这种情况只允许出现在有效负载包含来源于传输流分组中某个视频基本流的字节的PES 分组中。

4)    PTS_DTS：2 位字段。当值为'10'时，PTS 字段应出现在PES 分组标题中；当值为'11'时，PTS 字段和DTS 字段都应出现在PES 分组标题中；当值为'00'时，PTS 字段和DTS 字段都不出现在PES分组标题中。值'01'是不允许的。

5)    ESCR：1位。置'1'时表示ESCR 基础和扩展字段出现在PES 分组标题中；值为'0'表示没有ESCR 字段。

6)    ESrate：1 位。置'1'时表示ES rate 字段出现在PES 分组标题中；值为'0'表示没有ES rate 字段。

7)    DSMtrick mode：1 位。置'1'时表示有8 位特技方式字段；值为'0'表示没有该字段。

8)    Additionalinfo：1 位。附加版权信息标志字段。置'1'时表示有附加拷贝信息字段；值为'0'表示没有该字段。

9)    CRC：1 位。置'1'时表示CRC 字段出现在PES 分组标题中；值为'0'表示没有该字段。

10)  Extensionflag：1 位标志。置'1'时表示PES 分组标题中有扩展字段；值为'0'表示没有该字段。

PES header data length： 8 位。PES 标题数据长度字段。指出包含在PES 分组标题中的可选字段和任何填充字节所占用的总字节数。该字段之前的字节指出了有无可选字段。



### 附件：RTSP、RTCP、RTP 区别

```
RTP 和 RTSP 协议是应用层的，TCP 和 UDP 是传输层的，所以只能说 RTP OVER TCP/UDP。
而且一般情况下一个点播需要 RTSP+RTP+RTCP 个协议共同来实现。

RTP，RTCP 数据和 RTSP 数据共享 TCP 数据通道，所以必须有一个标识来区别三种数据。
RTP 和 RTCP 数据会以 $ 符号 ＋1 个字节的通道编号 ＋4 个字节的数据长度，共 6 个字节的前缀开始，
RTSP 数据是没有前缀数据的。

RTP 数据和 RTCP 数据的区别在于第二个字节的通道编号，据观察 RTP 通道编号是偶数，RTCP 通道编号是奇数。

1：RTSP 实时流协议
作为一个应用层协议，RTSP 提供了一个可供扩展的框架，它的意义在于使得实时流媒体数据的受控和点播变得可能。总的说来，RTSP 是一个流媒体表示协议，主要用来控制具有实时特性的数据发送，但它本身并不传输数据，而是必须依赖于下层传输协议所提供的某些服务。RTSP 可以对流媒体提供诸如播放、暂停、快进等操作，它负责定义具体的控制消息、操作方法、状态码等，此外还描述了与 RTP 间的交互操作（RFC2326）。

2：RTCP 控制协议
RTCP 控制协议需要与 RTP 数据协议一起配合使用，当应用程序启动一个 RTP 会话时将同时占用两个端口，分别供 RTP 和 RTCP 使用。RTP 本身并不能为按序传输数据包提供可靠的保证，也不提供流量控制和拥塞控制，这些都由 RTCP 来负责完成。通常 RTCP 会采用与 RTP 相同的分发机制，向会话中的所有成员周期性地发送控制信息，应用程序通过接收这些数据，从中获取会话参与者的相关资料，以及网络状况、分组丢失概率等反馈信息，从而能够对服务质量进行控制或者对网络状况进行诊断。

RTCP 协议的功能是通过不同的 RTCP 数据报来实现的，主要有如下几种类型：
SR：发送端报告，所谓发送端是指发出 RTP 数据报的应用程序或者终端，发送端同时也可以是接收端。(SERVER 定时间发送给 CLIENT)。
RR：接收端报告，所谓接收端是指仅接收但不发送 RTP 数据报的应用程序或者终端。(SERVER 接收 CLIENT 端发送过来的响应)。
SDES：源描述，主要功能是作为会话成员有关标识信息的载体，如用户名、邮件地址、电话号码等，此外还具有向会话成员传达会话控制信息的功能。
BYE：通知离开，主要功能是指示某一个或者几个源不再有效，即通知会话中的其他成员自己将退出会话。
APP：由应用程序自己定义，解决了 RTCP 的扩展性问题，并且为协议的实现者提供了很大的灵活性。

3：RTP 数据协议
RTP 数据协议负责对流媒体数据进行封包并实现媒体流的实时传输，每一个 RTP 数据报都由头部（Header）和负载（Payload）两个部分组成，其中头部前 12 个字节的含义是固定的，而负载则可以是音频或者视频数据。

RTP 用到的地方就是 PLAY ，服务器往客户端传输数据用 UDP 协议，RTP 是在传输数据的前面加了个 12 字节的头(描述信息)。

RTP 载荷封装设计本文的网络传输是基于 IP 协议，所以最大传输单元(MTU)最大为 1500 字节，在使用 IP／UDP／RTP 的协议层次结构的时候，这其中包括至少 20 字节的IP头，8 字节的UDP头，以及 12 字节的RTP头。这样，头信息至少要占用 40 个字节，那么 RTP 载荷的最大尺寸为 1460 字节。以 H264 为例，如果一帧数据大于 1460，则需要分片打包，然后到接收端再拆包，组合成一帧数据，进行解码播放。
```



### 参考：

http://blog.csdn.net/chen495810242/article/details/39207305

https://www.cnblogs.com/qingquan/archive/2011/07/28/2120440.html

http://www.cnblogs.com/qingquan/archive/2011/07/14/2106834.html

