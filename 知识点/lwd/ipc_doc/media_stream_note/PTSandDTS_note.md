### 理解音视频 PTS 和 DTS

https://www.cnblogs.com/samirchen/p/7071824.html

#### 视频

视频的播放过程可以简单理解为一帧一帧的画面按照时间顺序呈现出来的过程，就像在一个本子的每一页画上画，然后快速翻动的感觉。

但是在实际应用中，并不是每一帧都是完整的画面，因为如果每一帧画面都是完整的图片，那么一个视频的体积就会很大，这样对于网络传输或者视频数据存储来说成本太高，所以通常会对视频流中的一部分画面进行压缩（编码）处理。由于压缩处理的方式不同，视频中的画面帧就分为了不同的类别，其中包括：I 帧、P 帧、B 帧。

#### I、P、B 帧

I 帧、P 帧、B 帧的区别在于：

- I 帧（Intra coded frames）：I 帧图像采用帧内编码方式，即只利用了单帧图像内的空间相关性，而没有利用时间相关性。I 帧使用帧内压缩，不使用运动补偿，由于 I 帧不依赖其它帧，所以是随机存取的入点，同时是解码的基准帧。I 帧主要用于接收机的初始化和信道的获取，以及节目的切换和插入，I 帧图像的压缩倍数相对较低。I 帧图像是周期性出现在图像序列中的，出现频率可由编码器选择。
- P 帧（Predicted frames）：P 帧和 B 帧图像采用帧间编码方式，即同时利用了空间和时间上的相关性。P 帧图像只采用前向时间预测，可以提高压缩效率和图像质量。P 帧图像中可以包含帧内编码的部分，即 P 帧中的每一个宏块可以是前向预测，也可以是帧内编码。
- B 帧（Bi-directional predicted frames）：B 帧图像采用双向时间预测，可以大大提高压缩倍数。值得注意的是，由于 B 帧图像采用了未来帧作为参考，因此 MPEG-2 编码码流中图像帧的传输顺序和显示顺序是不同的。

也就是说，一个 I 帧可以不依赖其他帧就解码出一幅完整的图像，而 P 帧、B 帧不行。P 帧需要依赖视频流中排在它前面的帧才能解码出图像。B 帧则需要依赖视频流中排在它前面或后面的帧才能解码出图像。

这就带来一个问题：在视频流中，先到来的 B 帧无法立即解码，需要等待它依赖的后面的 I、P 帧先解码完成，这样一来播放时间与解码时间不一致了，顺序打乱了，那这些帧该如何播放呢？这时就需要我们来了解另外两个概念：DTS 和 PTS。

#### DTS、PTS 的概念

DTS、PTS 的概念如下所述：

- DTS（Decoding Time Stamp）：即解码时间戳，这个时间戳的意义在于告诉播放器该在什么时候解码这一帧的数据。
- PTS（Presentation Time Stamp）：即显示时间戳，这个时间戳用来告诉播放器该在什么时候显示这一帧的数据。

需要注意的是：虽然 DTS、PTS 是用于指导播放端的行为，但它们是在编码的时候由编码器生成的。

当视频流中没有 B 帧时，通常 DTS 和 PTS 的顺序是一致的。但如果有 B 帧时，就回到了我们前面说的问题：解码顺序和播放顺序不一致了。

比如一个视频中，帧的显示顺序是：I B B P，现在我们需要在解码 B 帧时知道 P 帧中信息，因此这几帧在视频流中的顺序可能是：I P B B，这时候就体现出每帧都有 DTS 和 PTS 的作用了。DTS 告诉我们该按什么顺序解码这几帧图像，PTS 告诉我们该按什么顺序显示这几帧图像。顺序大概如下：

```
   PTS: 1 4 2 3
   DTS: 1 2 3 4
Stream: I P B B
```

#### 音视频的同步

上面说了视频帧、DTS、PTS 相关的概念。我们都知道在一个媒体流中，除了视频以外，通常还包括音频。音频的播放，也有 DTS、PTS 的概念，但是音频没有类似视频中 B 帧，不需要双向预测，所以音频帧的 DTS、PTS 顺序是一致的。

音频视频混合在一起播放，就呈现了我们常常看到的广义的视频。在音视频一起播放的时候，我们通常需要面临一个问题：怎么去同步它们，以免出现画不对声的情况。

要实现音视频同步，通常需要选择一个参考时钟，参考时钟上的时间是线性递增的，编码音视频流时依据参考时钟上的时间给每帧数据打上时间戳。在播放时，读取数据帧上的时间戳，同时参考当前参考时钟上的时间来安排播放。这里的说的时间戳就是我们前面说的 PTS。实践中，我们可以选择：同步视频到音频、同步音频到视频、同步音频和视频到外部时钟。

#### 参考

- [理解音视频 PTS 和 DTS | www.samirchen.com](http://www.samirchen.com/about-pts-dts)
- [MPEG-2 Wiki](https://zh.wikipedia.org/wiki/MPEG-2)
- [MPEG-2 的同步及时间恢复](http://blog.csdn.net/hice1226/article/details/6717354)
- [Synching Video](http://dranger.com/ffmpeg/tutorial05.html)



### **视频带宽计算公式(码流_分辨率_帧率)**

#### **码流**

　　码流（Data Rate）是指视频文件在单位时间内使用的数据流量，也叫码率或码流率，是视频编码中画面质量控制中最重要的部分，一般我们用的单位是Kb/s或者Mb/s。一般来说同样分辨率下，视频文件的码流越大，压缩比就越小，画面质量就越高。码流越大，说明单位时间内取样率越大，数据流，精度就越高，处理出来的文件就越接近原始文件，图像质量越好，画质越清晰，要求播放设备的解码能力也越高。



#### **帧率**

   一帧就是一副静止的画面，连续的帧就形成动画，如电视图象等。我们通常说帧数，简单地说，就是在1秒钟时间里传输的图片的帧数，也可以理解为图形处理器每秒钟能够刷新几次，通常用fps（Frames Per Second）表示。每一帧都是静止的图象，快速连续地显示帧便形成了运动的假象。高的帧率可以得到更流畅、更逼真的动画。每秒钟帧数 (fps) 愈多，所显示的动作就会愈流畅。



#### **分辨率**

视频分辨率是指视频成像产品所成图像的大小或尺寸。常见的视像分辨率有352×288，176×144，640×480，1024×768。在成像的两组数字中，前者为图片长度，后者为图片的宽度，两者相乘得出的是图片的像素，长宽比一般为4：3. 　目前监控行业中主要使用Qcif(176×144）、CIF(352×288）、HALF D1(704×288）、D1(704×576）等几种分辨率。

D1是数字电视系统显示格式的标准，共分为以下5种规格：

D1：480i格式（525i）：720×480（水平480线，隔行扫描），和NTSC模拟电视清晰度相同，行频为15.25kHz，相当于我们所说的4CIF(720×576)

 

D2：480P格式（525p）：720×480（水平480线，逐行扫描），较D1隔行扫描要清晰不少，和逐行扫描DVD规格相同，行频为31.5kHz

 

D3：1080i格式（1125i）：1920×1080（水平1080线，隔行扫描），高清方式采用最多的一种分辨率，分辨率为1920×1080i/60Hz，行频为33.75kHz

 

D4：720p格式（750p）：1280×720（水平720线，逐行扫描），虽然分辨率较D3要低，但是因为逐行扫描，市面上更多人感觉相对于1080I（实际逐次540线）视觉效果更加清晰。不过个人感觉来说，在最大分辨率达到1920×1080的情况下，D3要比D4感觉更加清晰，尤其是文字表现力上，分辨率为1280×720p/60Hz，行频为45kHz

 

　　D5：1080p格式（1125p）：1920×1080（水平1080线，逐行扫描），目前民用高清视频的最高标准，分辨率为1920×1080P/60Hz，行频为67.5KHZ。

其中D1 和D2标准是我们一般模拟电视的最高标准，并不能称的上高清晰，D3的1080i标准是高清晰电视的基本标准，它可以兼容720p格式，而D5的1080P只是专业上的标准。

 

 

#### **帧率、码流与分辨率之间关系**



公式:

带宽 / (码流 * 8) = 同时在线人数

文件大小 = 时间×码率/8

 

**一个视频文件的大小为5.86M,播放时长为3分7秒:**

**1,该文件对应的码流就是**

**5.86 \* 1024 \* 1024 \* 8 / (3 \* 60 + 7) =262872.95657754bps**

**2,10M独享带宽能支撑的同时在线人数**

**10\* 1024 \* 1024 / 262872.95657754 =39.889078498294**

**3,支撑1000人同时在线的系统最少需要的带宽数为**

**262872\* 1000 / (1024 \* 1024) = 250.69427490234M**



### 分辨率、帧率、编码、码率知识普及

https://www.jianshu.com/p/4fed3c8a0643

#### 视频格式

大家所看到的文件名后缀， 如： MP4, 3GP, WMV, AVI,RM, RMVB等等. 实际上， 这些都是封装类型, 真正的视频格式不是文件名而是文件内的**视频编码方案和音频编码方案**。 能够播放哪些文件，实际取决于使用了哪个播放器, 以及**硬件解码芯片**能否识别该文件内的编码方案。

当mp4文件里的编码格式是h.264的时候，那么，它和同样编码的mkv、mov和flv，是可以无损转换的。可以理解为文件一样，就是包装不同。换个包装就行，里面的东西不必动。这就给无损转换编辑带来极大的画质保障。

#### 分辨率

这里有2个概念， 分别是：
 a. 物理分辨率, 即手机或PC屏幕能显示的像素数， 用W x H个像素表示。DPI
 b. 视频文件的分辨率， 这个是指视频画面的实际分辨率, 如， 320x240, 480x272, 640x480等等。PPI

每英寸**像素**（Pixel per inch, ppi）和每英寸**点**（Dot per inch, dpi），从技术角度说，“像素”（P）只存在于计算机显示领域，而“点”（d）只出现于打印或印刷领域。

- PPI
   图像分辨率（ImageResolution）指图像中存储的信息量。分辨率与图像大小成正比。
   图像分辨率决定了图像输出的质量，图像分辨率和图像尺寸(高宽)的值一起决定了文件的大小，且该值越大图形文件所占用的磁盘空间也就越多。图像分辨率以比例关系影响着文件的大小， 即文件大小与其图像分辨率的平方成正比。如果保持图像尺寸不变，将图像分辨率提高一倍，则其文件大小增大为原来的四倍。
- DPI
   设备分辨率（DeviceResolution）又称输出分辨率，指的是各类输出设备每英寸上可产生的点数，如显示器、喷墨打印机、激光打印机、绘图仪的分辨率。这种分辨率通过DPI来衡量，[PC](https://links.jianshu.com/go?to=https%3A%2F%2Fbaike.baidu.com%2Fitem%2FPC)显示器的设备分辨率在60至120DPI之间，打印设备的分辨率在360至2400DPI之间。

标清 480P （848 * 480分辨率）
 高清 720P （1280 * 720分辨率）
 超清 1080P (1920×1080分辨率)，蓝光
 2K （2048×1080分辨率）
 4K（4096×2160分辨率）

真正意义上的4K电影由4K摄像机拍摄，用4K放映机放映。还有的4K电影是由35mm胶片拍摄的，再转成4K的数字格式。

#### 帧率

(FPS, 帧/秒), 就是视频画面刷新的速度
 影响画面流畅度，与画面流畅度成正比：
 帧率越大，画面越流畅；
 帧率越小，画面越有跳动感。
 如果视频源来自摄像头，24FPS已经是肉眼极限，所以一般20帧的FPS就已经可以达到很好的用户体验了。

#### 视频编码

所谓视频编码方式就是指通过特定的压缩技术，将某个视频格式的文件转换成另一种视频格式文件的方式。视频流传输中最为重要的编解码标准有国际电联的H.261、H.263、H.264

#### 视频码率

视频码率就是数据传输时单位时间传送的数据位数，一般我们用的单位是kbps即千位每秒。通俗一点的理解就是取样率，单位时间内取样率越大，精度就越高，处理出来的文件就越接近原始文件。
 但是文件体积与取样率是成正比的，所以几乎所有的编码格式重视的都是如何用最低的码率达到最少的失真，围绕这个核心衍生出来的cbr（固定码率）与vbr（可变码率），都是在这方面做的文章，不过事情总不是绝对的。
 **视频码率基本的算法是：【码率】(kbps)=【文件大小】(KB) \* 8 / 【时间】(秒)**
 举例，D5的碟，容量4.3G，其中考虑到音频的不同格式，姑且算为600M，（故剩余容量为4.3*1024-600=3803.2M)，所以视频文件应不大于3.7G，本例中取视频文件的容量为3.446G，视频长度100分钟（6000秒），计算结果：码率约等于4818kbps(3.446 * 1024 * 1024 * 8 / 6000 = 4817.857)。

- 码率几点原则：

1、码率和质量成正比，但是文件体积也和码率成正比。这是要牢记的。
 2、码率超过一定数值，对图像的质量没有多大影响。
 3、视频码率　计算机中的信息都是二进制的0和1来表示，其中每一个0或1被称作一个位，用小写b表示，即bit（位）；大写B表示byte,即字节，一个字节=八个位，即1B=8b；前面的大写K表示1024的意思，即1024个位（Kb)或1024个字节(KB)。表示文件的大小单位，一般都使用字节（KB）来表示文件的大小。

- 网络速度都是用Kbps 来定义的 （注意是小b)
   Kbps：首先要了解的是，ps指的是/s，即每秒。Kbps指的是网络速度，也就是每秒钟传送多少个千位的信息（K表示千位，Kb表示的是多少千个位），为了在直观上显得网络的传输速度较快，一般公司都使用kb（千位）来表示。1KB/S=8Kbps。ADSL上网时的网速是512Kbps,如果转换成字节，就是512/8=64KB/S(即64千字节每秒）。
   **网络带宽Kbps/8 = KB/S**
   一般来说，如果是1M的宽带，在网上只能看不超过1024kbps的视频，超过1024kbps的视频只能等视频缓冲才能流畅的观看。

#### 清晰度

- 在码率一定的情况下，分辨率与清晰度成反比关系：分辨率越高，图像越不清晰，分辨率越低，图像越清晰。
- 在分辨率一定的情况下，码率与清晰度成正比关系，码率越高，图像越清晰；码率越低，图像越不清晰。

#### 手机转换（参考）

转换手机视频时， MP4格式是目前质量最好的, 其中， MPEG-4 SP规格的视频, 是目前兼容性最好的， 按照这种规格制作(或者转化)的视频, 可以保证兼容大多数手机。
 下面列出该规格的视频参数：

- 视频编码
   xvid 或者h.263（注意不是h.264）
- 视频分辨率
   320x240 (对于屏幕分辨率低于320x240的手机， 观看效果不好, 因此不建议使用)
- 视频码率
   256kbps - 320kbps
- 视频帧率
   15fps (中高端手机可以调整为25FPS, 观看体验更流畅)
- 音频编码
   AAC-LC
- 音频码率
   64kbps (或提高到96kbps)

请注意，视频码率+音频码率之和, 不要大于384kbps, 否则可能有些手机无法流畅播放。**（这个从百度上抄来的，好像指的两年前的手机，具体待确认后更新）**

附注：

- 微信公众号视频上传要求：
   微信公众平台发送视频的分辨率一般手机全屏的分辨率是320*640
   微信公众平台上传视频要求
   视频流：AVC H.264 8bit 平均码率1500Kbps以下，分辨率最高1920x1080(1080p 2K)。
   音频流：AAC 最高320Kbps (其实对于AAC来说，320K这个数字真没什么意义，又不是MP3)
   封装格式：flv

- 常用视频参数参考（老刘推荐）

  ![img](./pic_resource\PTSandDTS_note\video_param.png)