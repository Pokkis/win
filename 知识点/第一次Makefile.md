# Makefile

## 1、makefile是什么

`makefile`是一种组织大型项目软件编译的文件，它需要配合`make`命令使用。可以建立`makefile`、`cmake`、`sh`脚本等工程来管理和组织大型项目软件编译。[本文参考](https://www.cnblogs.com/wittxie/p/9836097.html#3-%E8%87%AA%E5%8A%A8%E5%8F%98%E9%87%8F)



## 2、makefile基础语法和规则

### 2.1 规则：

```
<target1> <target2> ...:<prerequisites1> <prerequisites2>...
<tab> <command>
```

其中参数：

- `target`（目标）：它可以是一个可执行文件，也可以是一个标签
- `prerequisites`（依赖）:指生成`target`（目标）所需要的文件或是目标
- `command`（命令）：`make`执行的命令（任意的`shell`命令）

这是一个文件的依赖关系，`<target>`这一个或多个的目标文件依赖于`<prerequisites>`中的文件，其生成规则定义在 `<command>`中。`<prerequisites>`中如果有一个以上的文件比`<target>`文件要新的话，`<command>`所定义的命令就会被执行，这是`makefile`的基本规则，也就是`makefile`中最核心的内容。

include 相当于将内容复制展开，export可以共享全局变量。

### 2.2 语法：

#### 2.2.1 符号

- 命令前缀

```
[不用前缀] 输出执行的命令以及命令执行的结果,出错的话停止执行
[前缀 @]  只输出命令执行的结果,出错的话停止执行
[前缀 -]  命令执行有错的话,忽略错误,继续执行
```

- 通配符

```
*表示任意一个或多个字符
? 表示任意一个字符
[...] [abcd] 表示a,b,c,d中任意一个字符, [^abcd]表示除a,b,c,d以外的字符, [0-9]表示 0~9中任意一个数字
```

- 自动变量

```

```

- 赋值

```
[=]： 最后在赋值，可以使用后面定义的变量
[:=]：立即赋值，只能使用前面定义好的变量
[+=]：变量追加值
```

- 伪目标

```
makefile有两个伪目标一个是.PHONY，另外一个是all
.PHONY：伪目标就是总是被执行的目标
all：一个目录下创建多个可执行程序，可以将所有程序的重建规则在一个makefile中描述
```

#### 2.2.2 隐含规则

- 自动推导重命名

```
编译c文件时，*.o的目标会自动推导成*.c
```

- 隐含变量

```
[RM] rm -f
[AR]	ar
[CC]	cc
[CXX]	g++
[ARFLAGS]	AR命令的参数
[CFLAGS] 语言编译器的参数
[CXXFLAGS]	C++语言编译器的参数
```

- 自动变量

```
[$@]	目标集合
[$%]	当目标是函数库文件时, 表示其中的目标文件名
[$<]	第一个依赖目标. 如果依赖目标是多个, 逐个表示依赖目标
[$?]	比目标新的依赖目标的集合
[$^]	所有依赖目标的集合, 会去除重复的依赖目标
[$+]	所有依赖目标的集合, 不会去除重复的依赖目标
[$*]	这个是GNU make特有的, 其它的make不一定支持
```

#### 2.2.3 定义



#### 2.2.4 函数



### 2.3 

## 3、makefile模板

### 3.1 编译so

```
#!/bin/bash
############################################################################
#
############################################################################
#源文件，自动找所有.c和.cpp文件，并将目标定义为同名.o文件
SOURCE  := $(wildcard *.c) $(wildcard *.cpp)
OBJS    := $(patsubst %.c,%.o,$(patsubst %.cpp,%.o,$(SOURCE)))

TARGET  := libxlib_alg.so
ROOT_DIR := /home/derek/share/xlib
  
############################################################################  
# 编译参数
############################################################################  
# 编译器
CC := gcc
LD := ld

# 编译宏
DEFINES := 

# 头文件路径
INCLUDE := -I$(ROOT_DIR)/include  

# 链接库
LIBS := -lpthread 

# 链接选项
LDFLAGS :=

# 汇总处理
CFLAGS := -g -Wall -O3 $(DEFINES) $(INCLUDE) $(LIBS)
  
############################################################################  
# 下面的基本上不需要做任何改动了
############################################################################  
all:$(OBJS)
    echo $(OBJS)
    $(LD) -shared -o $(TARGET) $(OBJS) $(LDFLAGS)

clean:
    echo "Removing linked and compiled files......"
    rm -fr *.o $(TARGET)

%.o:%.c
    @echo Compiling $< ...
    $(CC) -fPIC -c $(CFLAGS)  $< -o $*.o
```

###  3.2 编译app

```
#!/bin/bash
############################################################################
#
############################################################################
#源文件，自动找所有.c和.cpp文件，并将目标定义为同名.o文件
SOURCE  := $(wildcard *.c) $(wildcard *.cpp)
OBJS    := $(patsubst %.c,%.o,$(patsubst %.cpp,%.o,$(SOURCE)))
  
#目标文件名，输入任意你想要的执行文件名
TARGET  := cmd.bin
ROOT_DIR := /home/derek/share/xlib

############################################################################  
# 编译参数
############################################################################  
# 编译器
CC := gcc
LD := ld

# 编译宏
DEFINES :=

# 头文件路径
INCLUDE := -I$(ROOT_DIR)/include  

# 链接库
LIBS := -lpthread 

# 链接选项
LDFLAGS :=

# CFLAGS汇总处理
CFLAGS := -g -Wall -O3 $(DEFINES) $(INCLUDE) $(LIBS)

############################################################################  
# 下面的基本上不需要做任何改动了
############################################################################
.PHONY : everything clean rebuild

everything : $(TARGET)
all : $(TARGET)

rebuild: clean everything

clean:
    echo "Removing linked and compiled files......"
    rm -fr $(TARGET)
    rm -fr *.o

$(TARGET) : $(OBJS)
    echo $(OBJS)
    $(CC) $(CFLAGS) $(LDFLAGS) -o $@ $(OBJS) 
############################################################################
```